from google.appengine.api import images
import logging
from models import ImageThemeCache
from google.appengine.ext import db
from google.appengine.api import memcache

def flushCacheLabel(theme_key):
    
    if theme_key:
        q = db.GqlQuery("SELECT __key__ FROM ImageThemeCache WHERE theme_key = :1", theme_key)
    else:
        q = ImageThemeCache.all()
    
    results = q.fetch(100)
    db.delete(results)

    memcache.flush_all()

def flushCacheImage(image_key):
    
    if image_key:
        q = db.GqlQuery("SELECT __key__ FROM ImageThemeCache WHERE image_key = :1", image_key)
    else:
        q = ImageThemeCache.all()
    
    results = q.fetch(100)
    db.delete(results)

    memcache.flush_all()

def getWidth(blob_key, strip_size=0.01): 
    im = images.Image(blob_key=blob_key)
    im.crop(0.0,0.0,1.0,strip_size) 
    im_strip = images.Image(image_data=im.execute_transforms()) 
    return im_strip.width 

def getHeight(blob_key, strip_size=0.01): 
    im = images.Image(blob_key=blob_key)
    im.crop(0.0,0.0,strip_size,1.0) 
    im_strip = images.Image(image_data=im.execute_transforms()) 
    return im_strip.height 

"""Resize then optionally crop a given image.

Attributes:
img_data: The image data
width: The desired width
height: The desired height
halign: Acts like photoshop's 'Canvas Size' function, horizontally
            aligning the crop to left, middle or right
valign: Verticallly aligns the crop to top, middle or bottom

"""
def rescale(blob_key, width, height, halign='middle', valign='middle'):

    
    #image = images.Image(img_data)
    image = images.Image(blob_key=blob_key)
    
    imageHeight = getHeight(blob_key)
    imageWidth = getWidth(blob_key)
    


    desired_wh_ratio = float(width) / float(height)
    wh_ratio = float(imageWidth) / float(imageHeight)

    logging.debug('desired size (%d,%d)' % (width,height))
    logging.debug('current size (%d,%d)' % (imageWidth,imageHeight))
    logging.debug('desired ratio ' + str(desired_wh_ratio))
    logging.debug('current ratio ' + str(wh_ratio))

    if desired_wh_ratio > wh_ratio:
        # resize to width, then crop to height
        image.resize(width=width)
        newHeight = width / wh_ratio
        trim_y = max((float(newHeight - height) / 2) / newHeight,0.0)
        if valign == 'top':
            image.crop(0.0, 0.0, 1.0, 1 - (2 * trim_y))
        elif valign == 'bottom':
            image.crop(0.0, (2 * trim_y), 1.0, 1.0)
        else:
            logging.debug(str(trim_y) + ' = trim_y')

            image.crop(0.0, trim_y, 1.0, 1 - trim_y)
    else:
        # resize to height, then crop to width
        image.resize(height=height)
        newWidth = wh_ratio * height
        trim_x = max((float(newWidth - width) / 2) / newWidth,0.0)
        if halign == 'left':
            image.crop(0.0, 0.0, 1 - (2 * trim_x), 1.0)
        elif halign == 'right':
            image.crop((2 * trim_x), 0.0, 1.0, 1.0)
        else:
            image.crop(trim_x, 0.0, 1 - trim_x, 1.0)
    
    image.im_feeling_lucky()
    return image.execute_transforms()
